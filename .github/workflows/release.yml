name: Release

on:
  push:
    tags: ['v*']

permissions:
  contents: write
  id-token: write

env:
  CARGO_TERM_COLOR: always

jobs:
  # ============================================
  # Extract Version from Git Tag
  # ============================================
  verify:
    name: Extract Version
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      prerelease: ${{ steps.version.outputs.prerelease }}
    steps:
      - name: Extract version from tag
        id: version
        run: |
          TAG_VERSION="${GITHUB_REF_NAME#v}"

          # Validate semver format
          if ! [[ "$TAG_VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+(-[a-zA-Z0-9.]+)?$ ]]; then
            echo "::error::Tag '$GITHUB_REF_NAME' is not valid semver"
            exit 1
          fi

          echo "version=$TAG_VERSION" >> $GITHUB_OUTPUT

          # Check if prerelease
          if [[ "$TAG_VERSION" == *"-"* ]]; then
            echo "prerelease=true" >> $GITHUB_OUTPUT
          else
            echo "prerelease=false" >> $GITHUB_OUTPUT
          fi

          echo "Release version: $TAG_VERSION"

  # ============================================
  # Run CI First
  # ============================================
  ci:
    name: CI
    needs: verify
    uses: ./.github/workflows/ci.yml

  # ============================================
  # Build Release Artifacts
  # ============================================
  build:
    name: Build (${{ matrix.target }})
    needs: [verify, ci]
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
            cross: false
          - os: ubuntu-latest
            target: aarch64-unknown-linux-gnu
            cross: true
          - os: ubuntu-latest
            target: x86_64-unknown-linux-musl
            cross: true
          - os: macos-15  # ARM64
            target: aarch64-apple-darwin
            cross: false
          - os: windows-latest
            target: x86_64-pc-windows-msvc
            cross: false
    steps:
      - uses: actions/checkout@v6
      - uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}
      - uses: Swatinem/rust-cache@v2
        with:
          key: release-${{ matrix.target }}

      - name: Set version from tag
        shell: bash
        run: |
          VERSION="${{ needs.verify.outputs.version }}"
          echo "Setting workspace version to $VERSION"

          # Use perl for cross-platform in-place editing (macOS sed differs from GNU sed)
          # Update workspace version in root Cargo.toml
          perl -i -pe 's/^version = ".*"/version = "'"$VERSION"'"/' Cargo.toml

          # Update inter-crate path dependency versions
          find crates examples -name Cargo.toml -exec \
            perl -i -pe 's/(path = "\.\.\/[^"]*", )version = "[^"]*"/${1}version = "'"$VERSION"'"/g' {} +
          find crates examples -name Cargo.toml -exec \
            perl -i -pe 's/(path = "\.\.\/\.\.\/[^"]*", )version = "[^"]*"/${1}version = "'"$VERSION"'"/g' {} +

          echo "Workspace version:"
          grep '^version' Cargo.toml

      - name: Install cross
        if: matrix.cross
        run: cargo install cross --git https://github.com/cross-rs/cross

      - name: Build (cross)
        if: matrix.cross
        run: cross build --workspace --release --target ${{ matrix.target }}

      - name: Build (native)
        if: "!matrix.cross"
        run: cargo build --workspace --release --target ${{ matrix.target }}

      - name: Package artifacts
        shell: bash
        run: |
          VERSION="${{ needs.verify.outputs.version }}"
          TARGET="${{ matrix.target }}"
          RELEASE_DIR="target/${TARGET}/release"
          mkdir -p artifacts

          # Copy the laminardb server binary
          if [[ "${{ matrix.os }}" == "windows-latest" ]]; then
            cp "${RELEASE_DIR}/laminardb.exe" artifacts/ 2>/dev/null || true
            cp ${RELEASE_DIR}/*.dll artifacts/ 2>/dev/null || true
          else
            cp "${RELEASE_DIR}/laminardb" artifacts/ 2>/dev/null || true
            cp ${RELEASE_DIR}/*.so artifacts/ 2>/dev/null || true
            cp ${RELEASE_DIR}/*.dylib artifacts/ 2>/dev/null || true
            cp ${RELEASE_DIR}/*.a artifacts/ 2>/dev/null || true
          fi

          # Verify artifacts directory is not empty
          if [ -z "$(ls -A artifacts)" ]; then
            echo "::error::No artifacts found in ${RELEASE_DIR}"
            ls -la "${RELEASE_DIR}/" | head -30
            exit 1
          fi

          echo "Packaging artifacts:"
          ls -la artifacts/

          # Create archive
          cd artifacts
          if [[ "${{ matrix.os }}" == "windows-latest" ]]; then
            7z a ../laminardb-${TARGET}-v${VERSION}.zip *
          else
            tar -czvf ../laminardb-${TARGET}-v${VERSION}.tar.gz *
          fi

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: build-${{ matrix.target }}
          path: laminardb-${{ matrix.target }}-v*.tar.gz
          if-no-files-found: ignore

      - name: Upload artifact (Windows)
        if: matrix.os == 'windows-latest'
        uses: actions/upload-artifact@v4
        with:
          name: build-${{ matrix.target }}
          path: laminardb-${{ matrix.target }}-v*.zip

  # ============================================
  # Create GitHub Release
  # ============================================
  release:
    name: Create Release
    needs: [verify, build]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: Download all artifacts
        uses: actions/download-artifact@v7
        with:
          path: artifacts/
          pattern: build-*
          merge-multiple: true

      - name: Generate checksums
        run: |
          cd artifacts
          sha256sum * > checksums.sha256
          cat checksums.sha256

      - name: Extract release notes
        id: notes
        run: |
          VERSION="${{ needs.verify.outputs.version }}"
          if [ -f CHANGELOG.md ]; then
            awk "/^## \[?${VERSION}\]?/,/^## \[/" CHANGELOG.md | head -n -1 > notes.md || true
          fi
          if [ ! -s notes.md ]; then
            echo "Release v${VERSION}" > notes.md
            echo "" >> notes.md
            echo "See [CHANGELOG.md](CHANGELOG.md) for details." >> notes.md
          fi

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          draft: false
          prerelease: ${{ needs.verify.outputs.prerelease == 'true' }}
          body_path: notes.md
          files: |
            artifacts/laminardb-*.tar.gz
            artifacts/laminardb-*.zip
            artifacts/checksums.sha256
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # ============================================
  # Publish to crates.io
  # ============================================
  publish:
    name: Publish to crates.io
    needs: [verify, release]
    runs-on: ubuntu-latest
    if: needs.verify.outputs.prerelease == 'false'
    env:
      CARGO_REGISTRY_TOKEN: ${{ secrets.CARGO_REGISTRY_TOKEN }}
    steps:
      - uses: actions/checkout@v6
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2

      - name: Set version from tag
        run: |
          VERSION="${{ needs.verify.outputs.version }}"
          echo "Setting workspace version to $VERSION"

          # Update workspace version in root Cargo.toml
          perl -i -pe 's/^version = ".*"/version = "'"$VERSION"'"/' Cargo.toml

          # Update inter-crate path dependency versions
          find crates examples -name Cargo.toml -exec \
            perl -i -pe 's/(path = "\.\.\/[^"]*", )version = "[^"]*"/${1}version = "'"$VERSION"'"/g' {} +
          find crates examples -name Cargo.toml -exec \
            perl -i -pe 's/(path = "\.\.\/\.\.\/[^"]*", )version = "[^"]*"/${1}version = "'"$VERSION"'"/g' {} +

          echo "Workspace version:"
          grep '^version' Cargo.toml

      # Publish in dependency order
      - name: Publish laminar-derive
        run: cargo publish -p laminar-derive --registry crates-io
        continue-on-error: true

      - name: Wait for index
        run: sleep 30

      - name: Publish laminar-core
        run: cargo publish -p laminar-core --registry crates-io
        continue-on-error: true

      - name: Wait for index
        run: sleep 30

      - name: Publish laminar-sql
        run: cargo publish -p laminar-sql --registry crates-io
        continue-on-error: true

      - name: Wait for index
        run: sleep 30

      - name: Publish laminar-storage
        run: cargo publish -p laminar-storage --registry crates-io
        continue-on-error: true

      - name: Wait for index
        run: sleep 30

      - name: Publish laminar-connectors
        run: cargo publish -p laminar-connectors --registry crates-io
        continue-on-error: true

      - name: Wait for index
        run: sleep 30

      - name: Publish laminar-db
        run: cargo publish -p laminar-db --registry crates-io
        continue-on-error: true

  # ============================================
  # Update Compatibility Manifest
  # ============================================
  update-manifest:
    name: Update Compatibility Manifest
    needs: [verify, release]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v6
        with:
          ref: main
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Download checksums
        run: |
          gh release download ${{ github.ref_name }} --pattern checksums.sha256
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Update compatibility.json
        run: |
          VERSION="${{ needs.verify.outputs.version }}"

          cat > compatibility.json << EOF
          {
            "latest_version": "${VERSION}",
            "abi_version": 1,
            "released_at": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "minimum_supported": "0.1.0",
            "platforms": [
              "x86_64-unknown-linux-gnu",
              "aarch64-unknown-linux-gnu",
              "x86_64-unknown-linux-musl",
              "aarch64-apple-darwin",
              "x86_64-pc-windows-msvc"
            ],
            "download_base_url": "https://github.com/${{ github.repository }}/releases/download/v${VERSION}"
          }
          EOF

      - name: Commit and push
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add compatibility.json
          git commit -m "chore: update compatibility.json for v${{ needs.verify.outputs.version }}" || exit 0
          git push
